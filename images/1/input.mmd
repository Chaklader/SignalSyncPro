flowchart TD
    A["ğŸš¦ State Observation<br><b>32-D Vector (16 Ã— 2)</b><br>Phase: one-hot + duration [5]<br>Queues: vehicles + bikes [8]<br>Peds + Bus: count + time [3]"] --> B["ğŸ§  Policy Network<br><b>Q(s,a;Î¸)</b><br>32â†’256â†’256â†’128â†’3<br>ReLU + 107K params"]

    B --> C["ğŸ“Š Q-Value Computation"]

    C --> D["Q(Continue) = -1.2"]
    C --> E["Q(Skip to P1) = -0.8"]
    C --> F["Q(Next) = -1.5"]

    D --> G["ğŸ¯ Action Selection<br>Îµ-greedy Policy"]
    E --> G
    F --> G

    G -->|"Îµ probability"| H["ğŸ² Explore<br>Random action"]
    G -->|"1-Îµ probability"| I["âœ… Exploit<br>argmax Q(s,a;Î¸)"]

    H --> J["âš™ï¸ Execute in SUMO<br>Centralized Control<br>(both signals)"]
    I --> J

    J --> K["ğŸ”„ Observe<br>s_{t+1}, r_t, d_t"]

    K --> L["ğŸ“Š Reward (14 components)<br>Wait(2.5) Safety(2.0) Next(2.0)<br>Bus, Stability, Equity, etc.<br>Clip [-10, +10]"]

    L --> M["ğŸ“¥ TD Error<br>Î´ = r + Î³ max Q(s',a';Î¸â»)<br>- Q(s,a;Î¸)"]

    M --> N["ğŸ’¾ PER Buffer (50K)<br>Priority: (|Î´| + 0.01)^0.6<br>Store: (s,a,r,s',d,info)"]

    N --> O["Training Check<br>|Buffer| â‰¥ 1,000?"]

    O -->|"No"| P["Continue"]
    O -->|"Yes"| Q["ğŸ“š Sample Batch (64)<br>P(i) = p_i / Î£ p_k<br>with weights w_i"]

    P --> A

    Q --> R["ğŸ¯ Double DQN Target<br>a* = argmax Q(s',a';Î¸)<br>y = r + Î³(1-d)Q(s',a*;Î¸â»)<br>Clip [-10,+10]"]

    R --> S["ğŸ“‰ Weighted Loss<br>L = (1/64)Î£ w_iÂ·L_Huber(y - Q)<br>Compute TD errors"]

    S --> T["âš¡ Backprop + Update<br>Adam: Î·=1e-5, clip=0.5<br>Î¸ â† Î¸ - Î·âˆ‡L(Î¸)"]

    T --> U["ğŸ”„ Soft Target Update<br>Î¸â» â† 0.005Î¸ + 0.995Î¸â»<br>(every step)"]

    U --> V["ğŸ”„ Update Priorities<br>p_i â† (|Î´_i| + 0.01)^0.6"]

    V --> P

    W["ğŸ“‰ Decay Îµ<br>Îµ â† max(0.05, 0.98Îµ)<br>per episode"] -.-> A

    X["ğŸ’¾ Checkpoint<br>Save every 10 eps"] -.-> B

    style A fill:#E3F2FD,stroke:#1976D2,stroke-width:3px
    style B fill:#C8E6C9,stroke:#388E3C,stroke-width:3px
    style C fill:#FFF9C4,stroke:#F57C00,stroke-width:2px
    style D fill:#E1F5FE,stroke:#0288D1,stroke-width:1px
    style E fill:#FFE0B2,stroke:#F57C00,stroke-width:1px
    style F fill:#E1F5FE,stroke:#0288D1,stroke-width:1px
    style G fill:#81C784,stroke:#388E3C,stroke-width:3px
    style H fill:#FFCCBC,stroke:#D84315,stroke-width:2px
    style I fill:#A5D6A7,stroke:#388E3C,stroke-width:2px
    style J fill:#F48FB1,stroke:#C2185B,stroke-width:3px
    style K fill:#CE93D8,stroke:#7B1FA2,stroke-width:2px
    style L fill:#B39DDB,stroke:#512DA8,stroke-width:3px
    style M fill:#90CAF9,stroke:#1976D2,stroke-width:2px
    style N fill:#D1C4E9,stroke:#512DA8,stroke-width:3px
    style O fill:#B2DFDB,stroke:#00796B,stroke-width:2px
    style P fill:#E0F2F1,stroke:#00796B,stroke-width:1px
    style Q fill:#9C27B0,stroke:#4A148C,stroke-width:3px,color:#FFF
    style R fill:#7B1FA2,stroke:#4A148C,stroke-width:3px,color:#FFF
    style S fill:#6A1B9A,stroke:#311B92,stroke-width:3px,color:#FFF
    style T fill:#4A148C,stroke:#1A237E,stroke-width:3px,color:#FFF
    style U fill:#4CAF50,stroke:#1B5E20,stroke-width:3px,color:#FFF
    style V fill:#66BB6A,stroke:#2E7D32,stroke-width:2px
    style W fill:#FFF59D,stroke:#F57F17,stroke-width:2px
    style X fill:#FFE082,stroke:#F57F17,stroke-width:2px
